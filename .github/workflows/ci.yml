name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Run tests
      run: |
        if [ -f package.json ] && npm run test --silent 2>/dev/null; then
          npm test
        else
          echo "No tests configured, skipping..."
        fi

    - name: Validate Claude agent configurations
      run: |
        echo "Validating agent configurations..."
        for agent in .claude/agents/*.md; do
          if [ -f "$agent" ]; then
            echo "✓ Validating $agent"
            # 检查必需的YAML前置内容
            if ! grep -q "^name:" "$agent"; then
              echo "❌ Missing 'name' in $agent"
              exit 1
            fi
            if ! grep -q "^description:" "$agent"; then
              echo "❌ Missing 'description' in $agent"
              exit 1
            fi
          fi
        done

        for cmd in .claude/commands/*.md; do
          if [ -f "$cmd" ]; then
            echo "✓ Validating $cmd"
            # 检查必需的YAML前置内容
            if ! grep -q "^name:" "$cmd"; then
              echo "❌ Missing 'name' in $cmd"
              exit 1
            fi
            if ! grep -q "^description:" "$cmd"; then
              echo "❌ Missing 'description' in $cmd"
              exit 1
            fi
          fi
        done
        echo "All configurations validated! ✓"

    - name: Check CLI script
      run: |
        if [ -f ".claude/agents/cli.sh" ]; then
          echo "Validating CLI script..."
          # 检查脚本语法
          bash -n .claude/agents/cli.sh
          echo "✓ CLI script syntax is valid"

          # 检查可执行权限
          if [ -x ".claude/agents/cli.sh" ]; then
            echo "✓ CLI script has executable permissions"
          else
            echo "⚠️ CLI script lacks executable permissions"
          fi
        fi

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Run linter
      run: |
        if [ -f package.json ] && npm run lint --silent 2>/dev/null; then
          npm run lint
        else
          echo "No linter configured, skipping..."
        fi

    - name: Check markdown files
      uses: articulate/actions-markdownlint@v1
      with:
        config: .markdownlint.json
        ignore: node_modules
        files: '**/*.md'

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Run security audit
      run: |
        if [ -f package.json ]; then
          npm audit --audit-level moderate
        else
          echo "No package.json, skipping security audit..."
        fi

    - name: Scan for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: Build project
      run: |
        if [ -f package.json ] && npm run build --silent 2>/dev/null; then
          npm run build
        else
          echo "No build script configured, skipping..."
        fi

    - name: Create distribution package
      run: |
        echo "Creating distribution package..."
        mkdir -p dist
        cp -r .claude dist/
        cp README.md dist/
        cp LICENSE dist/
        cp CONTRIBUTING.md dist/
        cp CHANGELOG.md dist/
        echo "Distribution package created successfully!"

  docs:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check documentation
      run: |
        echo "Checking documentation completeness..."

        # 检查必需的文档文件
        required_docs=("README.md" "LICENSE" "CONTRIBUTING.md" "CHANGELOG.md")
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "✓ $doc exists"
          else
            echo "❌ Missing $doc"
            exit 1
          fi
        done

        # 检查智能体文档
        if [ -d ".claude/agents" ]; then
          agent_count=$(find .claude/agents -name "*.md" -not -name "README.md" | wc -l)
          echo "✓ Found $agent_count agent configurations"

          if [ $agent_count -lt 6 ]; then
            echo "⚠️ Expected at least 6 agent configurations"
          fi
        else
          echo "❌ Missing .claude/agents directory"
          exit 1
        fi

        # 检查命令文档
        if [ -d ".claude/commands" ]; then
          cmd_count=$(find .claude/commands -name "*.md" -not -name "README.md" | wc -l)
          echo "✓ Found $cmd_count command configurations"

          if [ $cmd_count -lt 6 ]; then
            echo "⚠️ Expected at least 6 command configurations"
          fi
        else
          echo "❌ Missing .claude/commands directory"
          exit 1
        fi

        echo "Documentation check completed! ✓"